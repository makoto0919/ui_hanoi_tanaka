<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãƒãƒã‚¤ã®å¡”</title>
<style>
    body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
    #start-screen, #game-screen { display: none; }
    #start-screen.active, #game-screen.active { display: block; }
  #controls { margin-top: 20px; display: flex; justify-content: center; gap: 20px; align-items: center; flex-wrap: wrap; }
  #game { display: flex; justify-content: center; gap: 2vw; margin-top: 20px; flex-wrap: nowrap; overflow-x: auto; }
  .tower {
   width: 300px;
   height: 300px;
   background: #ddd;
   position: relative;
   border-radius: 10px;
   display: flex;
   flex-direction: column-reverse;
   align-items: center;
   padding: 10px;
   box-sizing: border-box;
   overflow: hidden;
   /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
    overflow-y: auto;             /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ã«ã™ã‚‹ */
    overflow-x: hidden;           /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯éš ã™ */
  }
  .disk {
   max-width: 100%;
   box-sizing: border-box;
   display: block;
   height: 24px;
   margin: 3px 0;
   border-radius: 6px;
   cursor: grab;
   border: 2px solid rgba(0,0,0,0.3);
    box-shadow: inset 0 2px 4px rgba(255,255,255,0.3),
                0 3px 6px rgba(0,0,0,0.4);
  }
  #history-container { margin-top: 20px; display: none !important; }
  #history-container.show { display: block !important; }
  #history-log { max-height: 150px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #aaa; text-align: left; width: 300px; margin: 0 auto; }
  #toggle-history-under { margin-top: 20px; }
  .disk.clickable {
   cursor: pointer;
  }
  /* ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚¬ã‚¤ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#keyboard-guide {
  font-size: 0.9em;
  color: #555;
  background-color: #e0e0e0;
  padding: 8px 15px;
  border-radius: 5px;
  margin-bottom: 15px; /* ä»–ã®è¦ç´ ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ */
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px; /* ã‚­ãƒ¼ã¨æ©Ÿèƒ½ã®é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
}

#keyboard-guide span {
  font-weight: bold;
  color: #333;
}

#victory-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border: 2px solid #888;
  border-radius: 12px;
  padding: 20px 30px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  z-index: 9999;
  display: none;
  text-align: center;
}
#victory-popup h2 {
  margin-bottom: 20px;
}
#victory-popup button {
  margin: 5px 10px;
  padding: 8px 14px;
  border: none;
  border-radius: 5px;
  font-size: 1em;
  cursor: pointer;
}

select, button {
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 8px;
  margin: 5px 0;
}

.tower-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.tower-label {
  margin-top: 8px;
  font-size: 1em;
  color: #333;
}

#rule-section {
  background: #fff;
  border: 1px solid #ccc;
  padding: 15px 20px;
  margin-top: 20px;
  border-radius: 10px;
  text-align: left;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#rule-section h2 {
  text-align: center;
  color: #333;
  margin-bottom: 10px;
}

#rule-section ul {
  list-style-type: disc;
  padding-left: 20px;
}

#rule-image {
  display: block;
  margin: 20px auto 0;
  max-width: 60%;
  height: auto;
}

#hint-popup {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.hint-content {
  background: white;
  padding: 30px;
  border-radius: 12px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.hint-content button {
  margin-top: 20px;
  padding: 10px 20px;
  font-size: 1em;
  border: none;
  border-radius: 8px;
  background-color: #4CAF50;
  color: white;
  cursor: pointer;
}
.hint-content button:hover {
  background-color: #45a049;
}
.tower.highlight {
  outline: 4px solid #4CAF50;
  box-shadow: 0 0 10px #4CAF50;
}





 </style>
</head>
<body tabindex="0">
 <div id="start-screen" class="active">
  <h1>ãƒãƒã‚¤ã®å¡” ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸</h1>
  <p>å††ç›¤ã®æ•°ã‚’é¸ã‚“ã§ãã ã•ã„ï¼ˆ3ã€œ20ï¼‰ï¼š
  <select id="disk-select">
   <option value="3" selected>3</option>
   <option value="4">4</option>
   <option value="5">5</option>
   <option value="6">6</option>
   <option value="7">7</option>
   <option value="8">8</option>
  <option value="9">9</option>
   <option value="10">10</option>
   <option value="11">11</option>
   <option value="12">12</option>
   <option value="13">13</option>
   <option value="14">14</option>
   <option value="15">15</option>
   <option value="16">16</option>
   <option value="17">17</option>
   <option value="18">18</option>
   <option value="19">19</option>
   <option value="20">20</option>
  </select></p>
  <p>å††ç›¤ã«æŸ„ã‚’ã¤ã‘ã¾ã™ã‹ï¼Ÿ
  <select id="pattern-select">
   <option value="off">æŸ„ãªã—</option>
   <option value="on">æŸ„ã‚ã‚Š</option>
   <option value="number" selected>æ•°å­—ä»˜ã</option>
  </select></p>
  <p>é¸æŠä¸­ã®å††ç›¤ã‚’ç§»å‹•ã§ãã‚‹å¡”ã«ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ
  <select id="highlight-toggle">
    <option value="on" selected>ã¯ã„</option>
    <option value="off">ã„ã„ãˆ</option>
  </select>
  </p>
  <p><strong>æ“ä½œæ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„</strong>ï¼š
  <select id="mode-select">
   <option value="drag">ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®ã¿</option>
   <option value="click">ã‚¯ãƒªãƒƒã‚¯ç§»å‹•ã®ã¿</option>
   <option value="keyboard" selected>ãƒœã‚¿ãƒ³æ“ä½œã®ã¿</option>
   <!--<option value="natural">è‡ªç„¶è¨€èªæ“ä½œãƒ¢ãƒ¼ãƒ‰</option>
   <option value="voice">éŸ³å£°æ“ä½œãƒ¢ãƒ¼ãƒ‰</option>-->
  </select></p>
<!-- ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®èª¬æ˜ã‚’è¿½åŠ  -->

  <button id="start-btn">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
  <div id="rule-section">
    <h2>ğŸ® æ“ä½œãƒ¢ãƒ¼ãƒ‰ã®èª¬æ˜</h2>
  <ul>
    <li><strong>ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã®ã¿ï¼š</strong> å††ç›¤ã‚’ãƒã‚¦ã‚¹ã§ã¤ã‹ã‚“ã§å¡”ã«ç§»å‹•ã—ã¾ã™</li>
    <li><strong>ã‚¯ãƒªãƒƒã‚¯ç§»å‹•ã®ã¿ï¼š</strong> å††ç›¤ã‚’ã‚¯ãƒªãƒƒã‚¯â†’ç§»å‹•å…ˆã®å¡”ã‚’ã‚¯ãƒªãƒƒã‚¯ã§æ“ä½œã—ã¾ã™</li>
    <li><strong>ãƒœã‚¿ãƒ³æ“ä½œã®ã¿ï¼š</strong> æ•°å­—ã‚­ãƒ¼ï¼ˆ1ã€œ3ï¼‰ã§å¡”ã‚’é¸æŠã€Rã§ãƒªã‚»ãƒƒãƒˆã€Zã§1æ‰‹æˆ»ã™ ãªã©</li>
    <!--<li><strong>è‡ªç„¶è¨€èªæ“ä½œãƒ¢ãƒ¼ãƒ‰ï¼š</strong> ã€Œå·¦ã‹ã‚‰å³ã¸å‹•ã‹ã—ã¦ã€ãªã©ã¨ãƒ†ã‚­ã‚¹ãƒˆã§æŒ‡ç¤ºã§ãã¾ã™</li>
    <li><strong>éŸ³å£°æ“ä½œãƒ¢ãƒ¼ãƒ‰ï¼š</strong> ãƒã‚¤ã‚¯ã§æŒ‡ç¤ºã§ãã¾ã™ï¼ˆä¾‹ï¼šã€Œä¸­å¤®ã®å¡”ã‹ã‚‰å³ã¸ç§»å‹•ã€ï¼‰</li>
    <li><strong>ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼š</strong> ãƒˆãƒ©ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰ä¸Šã®ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã§æŒ‡ç¤ºã§ãã¾ã™</li>-->
  </ul>
  <h2>ğŸ§© ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ« ğŸ§©</h2>
  <p>ã€Œãƒãƒã‚¤ã®å¡”ã€ã¯ï¼Œã™ã¹ã¦ã®å††ç›¤ã‚’å·¦ã®å¡”ã‹ã‚‰å³ã®å¡”ã«ç§»å‹•ã•ã›ã‚‹ãƒ‘ã‚ºãƒ«ã§ã™ã€‚</p>
  <ul>
    <li>ä¸€åº¦ã«å‹•ã‹ã›ã‚‹ã®ã¯å¡”ã®ä¸€ç•ªä¸Šã«ã‚ã‚‹1æšã®å††ç›¤ã ã‘</li>
    <li>å††ç›¤ã®ä¸Šã«ãã®å††ç›¤ã‚ˆã‚Šã‚‚å¤§ããªå††ç›¤ã‚’ç½®ãã“ã¨ã¯ã§ããªã„</li>
    <li>3ã¤ã®å¡”ã®é–“ã§ç§»å‹•ã•ã›ã‚‹</li>
  </ul>
  <p>æœ€å°æ‰‹æ•°ã§ã®ã‚¯ãƒªã‚¢ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼</p>
  <img src="/Users/tanakamakoto/Library/CloudStorage/GoogleDrive-material-0919@g.ecc.u-tokyo.ac.jp/ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–/Uni/4S/UI/public/rule.png" alt="ãƒãƒã‚¤ã®å¡”ã®ãƒ«ãƒ¼ãƒ«å›³è§£" id="rule-image">
</div>

 </div>

 <div id="game-screen">
  <h1>ãƒãƒã‚¤ã®å¡”</h1>
  <div id="controls">
  <p id="keyboard-guide" style="display: none;">
    <span style="font-weight: bold;">[ãƒœã‚¿ãƒ³æ“ä½œã‚¬ã‚¤ãƒ‰]</span><br>
    <span>M</span>ã‚­ãƒ¼: ãƒ¡ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹ &nbsp; <span>R</span>ã‚­ãƒ¼: ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ &nbsp; <span>Z</span>ã‚­ãƒ¼: ä¸€æ‰‹æˆ»ã™ &nbsp; <span>H</span>ã‚­ãƒ¼: ç§»å‹•å±¥æ­´ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ<br>
    <span>1</span>ã€œ<span>3</span>ã‚­ãƒ¼: ãƒ‡ã‚£ã‚¹ã‚¯ã®é¸æŠã¨ç§»å‹•ã‚’è¡Œã„ã¾ã™ã€‚ã€Œå‹•ã‹ã™å††ç›¤ã®ã‚ã‚‹å¡”ã‚’é¸æŠâ†’ç§»å‹•å…ˆã®å¡”ã‚’é¸æŠã€ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚<br>
    <span style="font-size: 0.9em; color: #666;">ä¾‹: <span style="font-weight: bold;">1</span>ã‚­ãƒ¼ã§å·¦ã®å¡”ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’é¸æŠã—ã€<span style="font-weight: bold;">3</span>ã‚­ãƒ¼ã§å³ã®å¡”ã¸ç§»å‹•ã•ã›ã¾ã™ã€‚</span>
  </p>
  <button id="reset-btn">ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
  <button id="undo-btn">1æ‰‹æˆ»ã™</button>
  <button id="back-btn">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>
  <button id="rule-btn" style="position:absolute; top:10px; right:10px;">ãƒ«ãƒ¼ãƒ«</button>

</div>
<div id="nlp-controls" style="display: none; margin-top: 10px;">
  <input id="nlp-input" type="text" placeholder="ä¾‹ï¼šå·¦ã‹ã‚‰å³ã«å‹•ã‹ã—ã¦" style="width: 60%; padding: 8px; font-size: 1em;">
  <button id="nlp-submit">é€ä¿¡</button>
</div>
<div id="voice-controls" style="display: none; margin-top: 10px;">
  <button id="voice-start">ğŸ¤ éŸ³å£°å…¥åŠ›é–‹å§‹</button>
  <span id="voice-status" style="margin-left: 10px; color: #555;">å¾…æ©Ÿä¸­</span>
</div>

  <div id="game">
  <div class="tower-container">
    <div class="tower" id="tower-0" data-label="å·¦ã®å¡”"></div>
    <div class="tower-label">â‘ å·¦ã®å¡”</div>
  </div>
  <div class="tower-container">
    <div class="tower" id="tower-1" data-label="ä¸­å¤®ã®å¡”"></div>
    <div class="tower-label">â‘¡ä¸­å¤®ã®å¡”</div>
  </div>
  <div class="tower-container">
    <div class="tower" id="tower-2" data-label="å³ã®å¡”"></div>
    <div class="tower-label">â‘¢å³ã®å¡”</div>
  </div>
</div>

  <div id="toggle-history-under">
    <span>æ‰‹æ•°: <span id="move-count">0</span></span><br>
   <button id="toggle-history">ï¼‹ç§»å‹•å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹</button>
  </div>
  <div id="history-container">
   <h3>ç§»å‹•å±¥æ­´</h3>
   <div id="history-log"></div>
  </div>
 </div>
 <div id="victory-popup">
  <h2>ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å…¨ã¦ã®å††ç›¤ã‚’ç§»å‹•ã§ãã¾ã—ãŸï¼ ğŸ‰</h2>
  <button id="retry-btn">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹</button>
  <button id="back-main-btn">ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</button>
  <button id="close-popup-btn">é–‰ã˜ã‚‹</button>
</div>
<div id="hint-popup" style="display: none;">
  <div class="hint-content">
    <h2>ğŸ’¡ åˆã‚ã¦ã®æ–¹ã¸</h2>
    <p>ã“ã®ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã‚„æ“ä½œèª¬æ˜ã¯ãƒšãƒ¼ã‚¸ä¸‹ã«ã‚ã‚Šã¾ã™ã€‚<br>ã¾ãšã¯3æšã®å††ç›¤ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
    <button id="close-hint-btn">ã‚ã‹ã£ãŸï¼</button>
  </div>
</div>
<div id="rule-popup" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
 background:#fff; border:2px solid #888; border-radius:12px; padding:20px 30px; box-shadow:0 4px 20px rgba(0,0,0,0.3);
 z-index:9999; text-align:center; max-width:500px;">
  <h2>ãƒãƒã‚¤ã®å¡” ãƒ«ãƒ¼ãƒ«</h2>
  <p>â€¢ 1å›ã«å‹•ã‹ã›ã‚‹ã®ã¯å¡”ã®ä¸€ç•ªä¸Šã®1æšã®å††ç›¤ã ã‘ã§ã™ã€‚<br>
     â€¢ å°ã•ã„å††ç›¤ã®ä¸Šã«å¤§ãã„å††ç›¤ã¯ç½®ã‘ã¾ã›ã‚“ã€‚<br>
     â€¢ ã™ã¹ã¦ã®å††ç›¤ã‚’å·¦ã‹ã‚‰å³ã®å¡”ã«ç§»å‹•ã™ã‚Œã°ã‚¯ãƒªã‚¢ã§ã™ã€‚</p>
     <img src="/Users/tanakamakoto/Library/CloudStorage/GoogleDrive-material-0919@g.ecc.u-tokyo.ac.jp/ãƒã‚¤ãƒ‰ãƒ©ã‚¤ãƒ–/Uni/4S/UI/public/rule.png" alt="ãƒãƒã‚¤ã®å¡”ã®ãƒ«ãƒ¼ãƒ«å›³è§£" id="rule-image">
  <button id="close-rule-btn">é–‰ã˜ã‚‹</button>
</div>



 <script>
// åŠ¹æœéŸ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
const sounds = {
  move: new Audio('sounds/move.mp3'),
  invalid: new Audio('sounds/invalid.mp3'),
  victory: new Audio('sounds/victory.mp3')
};

const moveSounds = {
    1: new Audio('sounds/move_Pitch_Changer.mp3'),
    2: new Audio('sounds/move_Pitch_Changer-2.mp3'),
    3: new Audio('sounds/move_Pitch_Changer-3.mp3'),
    4: new Audio('sounds/move_Pitch_Changer-4.mp3'),
    5: new Audio('sounds/move_Pitch_Changer-5.mp3'),
    6: new Audio('sounds/move_Pitch_Changer-6.mp3'),
    7: new Audio('sounds/move_Pitch_Changer-7.mp3'),
    8: new Audio('sounds/move_Pitch_Changer-8.mp3'),
    9: new Audio('sounds/move_Pitch_Changer-9.mp3'),
    10: new Audio('sounds/move_Pitch_Changer-10.mp3'),
    11: new Audio('sounds/move_Pitch_Changer-11.mp3'),
    12: new Audio('sounds/move_Pitch_Changer-12.mp3'),
    13: new Audio('sounds/move_Pitch_Changer-13.mp3'),
    14: new Audio('sounds/move_Pitch_Changer-14.mp3'),
    15: new Audio('sounds/move_Pitch_Changer-15.mp3'),
    16: new Audio('sounds/move_Pitch_Changer-16.mp3'),
    17: new Audio('sounds/move_Pitch_Changer-17.mp3'),
    18: new Audio('sounds/move_Pitch_Changer-18.mp3'),
    19: new Audio('sounds/move_Pitch_Changer-19.mp3'),
    20: new Audio('sounds/move_Pitch_Changer-20.mp3')    
}

let moveCount = 0;
let previousMoves = [];
let selectedDisk = null; // ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§é¸æŠã•ã‚ŒãŸãƒ‡ã‚£ã‚¹ã‚¯ã‚’ä¿æŒ
let sourceTower = null; // ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§é¸æŠã•ã‚ŒãŸãƒ‡ã‚£ã‚¹ã‚¯ã®å…ƒã¨ãªã‚‹å¡”ã‚’ä¿æŒ
let currentMode = 'drag'; // ç¾åœ¨ã®æ“ä½œãƒ¢ãƒ¼ãƒ‰ã‚’ä¿æŒ
let highlightEnabled = true;  // åˆæœŸå€¤ã¯ã‚ªãƒ³


// åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
document.addEventListener('DOMContentLoaded', () => {
    const startButton = document.getElementById('start-btn');
    const startScreen = document.getElementById('start-screen');
    const gameScreen = document.getElementById('game-screen');
    const diskSelect = document.getElementById('disk-select');
    const patternSelect = document.getElementById('pattern-select');
    const modeSelect = document.getElementById('mode-select');
    const resetButton = document.getElementById('reset-btn');
    const undoButton = document.getElementById('undo-btn');
    const backButton = document.getElementById('back-btn');
    const toggleHistoryButton = document.getElementById('toggle-history');
    const historyContainer = document.getElementById('history-container');
    const highlightSelect = document.getElementById('highlight-toggle');

    const ruleBtn = document.getElementById('rule-btn');
    const rulePopup = document.getElementById('rule-popup');
    const closeRuleBtn = document.getElementById('close-rule-btn');

    ruleBtn.addEventListener('click', () => {
        rulePopup.style.display = 'block';
    });

    closeRuleBtn.addEventListener('click', () => {
        rulePopup.style.display = 'none';
    });

    const controls = document.getElementById('controls');
    const timerDiv = document.createElement('div');
    timerDiv.id = 'timer-display';
    timerDiv.style.marginLeft = '20px';
    timerDiv.style.fontWeight = 'bold';
    timerDiv.style.color = '#333';
    timerDiv.textContent = 'çµŒéæ™‚é–“: 0:00';
    controls.appendChild(timerDiv);



    // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    startButton.addEventListener('click', () => {
        highlightEnabled = (highlightSelect.value === 'on');
        const numDisks = parseInt(diskSelect.value);
        const pattern = patternSelect.value;
        currentMode = modeSelect.value; // ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š

        // åˆå›ç„¡éŸ³å†ç”Ÿã§ãƒ–ãƒ©ã‚¦ã‚¶åˆ¶é™ã‚’è§£é™¤ã™ã‚‹
        Object.values(sounds).forEach(audio => {
            audio.volume = 0;
            audio.play().catch(() => {});
            audio.pause();
            audio.currentTime = 0;
            audio.volume = 1;
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        const keyboardGuide = document.getElementById('keyboard-guide');
        if (currentMode === 'keyboard') {
            keyboardGuide.style.display = 'block';
            resetButton.style.display = 'none';
            undoButton.style.display = 'none';
            backButton.style.display = 'none';
        } else {
            keyboardGuide.style.display = 'none';
            resetButton.style.display = 'inline-block';
            undoButton.style.display = 'inline-block';
            backButton.style.display = 'inline-block';
        }

        startScreen.classList.remove('active');
        gameScreen.classList.add('active');

        initializeGame(numDisks, pattern, currentMode); // åˆæœŸåŒ–æ™‚ã«ãƒ¢ãƒ¼ãƒ‰ã‚’æ¸¡ã™

        // å±¥æ­´ã¨æ‰‹æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('history-log').innerHTML = '';
        moveCount = 0;
        document.getElementById('move-count').textContent = moveCount;
        previousMoves = [];

        const nlpControls = document.getElementById('nlp-controls');
        nlpControls.style.display = (currentMode === 'natural') ? 'block' : 'none';

        startTimer();
    });

    // ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    resetButton.addEventListener('click', () => {
        const threshold = 10; // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å‡ºã™åŸºæº–æ‰‹æ•°
        if (moveCount >= threshold) {
            const confirmReset = confirm("ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ");
            if (!confirmReset) {
                return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ä¸­æ–­
            }
        }
        const numDisks = parseInt(diskSelect.value);
        const pattern = patternSelect.value;
        // currentMode ã‚’ä½¿ç”¨ã—ã¦ã€ãƒªã‚»ãƒƒãƒˆæ™‚ã‚‚ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’ç¶­æŒ
        initializeGame(numDisks, pattern, currentMode);
        moveCount = 0;
        document.getElementById('move-count').textContent = moveCount;
        previousMoves = [];
        document.getElementById('history-log').innerHTML = '';
        selectedDisk = null; // ãƒªã‚»ãƒƒãƒˆæ™‚ã«é¸æŠä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’è§£é™¤
        sourceTower = null;
        clearTowerHighlights();
        startTimer();
    });

    // 1æ‰‹æˆ»ã™ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    undoButton.addEventListener('click', () => {
        const lastMove = previousMoves.pop();
        if (!lastMove) return; // æˆ»ã™æ‰‹ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

        const [fromId, toId, diskSize] = lastMove;
        const fromTower = document.getElementById(fromId);
        const toTower = document.getElementById(toId);

        // ç§»å‹•ã—ãŸãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç‰¹å®šã—ã¦å…ƒã®å¡”ã«æˆ»ã™
        const diskToMoveBack = Array.from(toTower.children).find(disk => disk.dataset.size == diskSize);
        if (diskToMoveBack) {
            fromTower.appendChild(diskToMoveBack);
            moveCount = Math.max(0, moveCount - 1); // æ‰‹æ•°ã‚’æ¸›ã‚‰ã™
            document.getElementById('move-count').textContent = moveCount;

            // å±¥æ­´ãƒ­ã‚°ã‹ã‚‰æœ€æ–°ã®ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
            const historyLog = document.getElementById('history-log');
            historyLog.lastChild?.remove();
        } else {
            // ãƒ‡ã‚£ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€ç§»å‹•å±¥æ­´ã‚’å…ƒã«æˆ»ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
            previousMoves.push(lastMove);
            console.error('å…ƒã«æˆ»ã™ãƒ‡ã‚£ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }

        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã€ãƒ‡ã‚£ã‚¹ã‚¯ã®æ“ä½œå¯èƒ½çŠ¶æ…‹ã‚’æ›´æ–°
        if (currentMode === 'drag') {
            updateDraggableDisks();
        } else if (currentMode === 'click') {
            selectedDisk?.classList.remove('dragging', 'clickable');
            selectedDisk = null;
            sourceTower = null;
            updateClickableDisks(); // ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€ã‚¯ãƒªãƒƒã‚¯å¯èƒ½çŠ¶æ…‹ã‚’æ›´æ–°
        } else if (currentMode === 'keyboard') {
            selectedDisk?.classList.remove('dragging', 'clickable');
            selectedDisk = null;
            sourceTower = null;
        }
    });

    // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    backButton.addEventListener('click', () => {
        document.body.focus();
        // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹éš›ã«ã€ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
        document.getElementById('keyboard-guide').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'inline-block';
        document.getElementById('undo-btn').style.display = 'inline-block';
        document.getElementById('back-btn').style.display = 'inline-block';

        document.getElementById('game-screen').classList.remove('active');
        document.getElementById('start-screen').classList.add('active');
        selectedDisk = null; // ãƒ¡ã‚¤ãƒ³ã«æˆ»ã‚‹éš›ã«é¸æŠä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’è§£é™¤
        sourceTower = null;
        clearTowerHighlights();
    });

    // ç§»å‹•å±¥æ­´è¡¨ç¤º/éè¡¨ç¤ºãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    toggleHistoryButton.addEventListener('click', () => {
        historyContainer.classList.toggle('show');
        toggleHistoryButton.textContent = historyContainer.classList.contains('show') ? 'âˆ’ç§»å‹•å±¥æ­´ã‚’éè¡¨ç¤ºã«ã™ã‚‹' : 'ï¼‹ç§»å‹•å±¥æ­´ã‚’è¡¨ç¤ºã™ã‚‹';
    });

    document.getElementById('retry-btn').addEventListener('click', () => {
        document.getElementById('victory-popup').style.display = 'none';
        document.getElementById('reset-btn').click();
    });

    document.getElementById('back-main-btn').addEventListener('click', () => {
        document.getElementById('victory-popup').style.display = 'none';
        document.getElementById('back-btn').click();
    });

    document.getElementById('close-popup-btn').addEventListener('click', () => {
        document.getElementById('victory-popup').style.display = 'none';
    });

    // åˆå›èµ·å‹•æ™‚ã®ã¿ãƒ’ãƒ³ãƒˆè¡¨ç¤º ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ localStorage.clear() ã‚’å®Ÿè¡Œã—ã¦ãƒªã‚»ãƒƒãƒˆå¯èƒ½
    if (!localStorage.getItem('hanoiHintShown')) {
        const hintPopup = document.getElementById('hint-popup');
        const closeHintBtn = document.getElementById('close-hint-btn');
        hintPopup.style.display = 'flex';

        closeHintBtn.addEventListener('click', () => {
            hintPopup.style.display = 'none';
            localStorage.setItem('hanoiHintShown', 'true');
    });
}


});


let drawing = false;
let points = [];
let gestureState = null;
let fromTower = null;
let startTime = null;
let timerInterval = null;

function playMoveSound(diskSize, maxDisks) {
    const totalSounds = 20;
    const center = 13;  // åŸºæº–éŸ³

    let selectedIndexes = [];

    if (maxDisks === totalSounds) {
        // 20æšã®ã¨ãã¯1:1ã§å…¨ã¦ã®éŸ³ã‚’ä½¿ã†
        selectedIndexes = Array.from({length: totalSounds}, (_, i) => totalSounds - i);
    } else {
        // maxDisksæšç”¨ã«ã€13ã‚’ä¸­å¿ƒã«ã—ãŸéŸ³ã‚’å‡ç­‰ã«é¸ã¶
        // ã¾ãš20éŸ³ã‚’ã€ŒåŸºæº–13ã‚’ä¸­å¿ƒã«ã—ãŸãƒªã‚¹ãƒˆã€ã«ã‚½ãƒ¼ãƒˆ
        const ordered = [
            ...Array.from({length: totalSounds - center}, (_, i) => center + (i + 1)), // é«˜éŸ³å´ï¼ˆ14ã€œ20ï¼‰
            center,
            ...Array.from({length: center - 1}, (_, i) => center - (i + 1)) // ä½éŸ³å´ï¼ˆ12ã€œ1ï¼‰
        ];

        // å‡ç­‰ã«maxDiskså€‹ã‚’æŠ½å‡ºï¼ˆå°ã•ã„å††ç›¤é †ã«é«˜éŸ³å´ã‹ã‚‰ï¼‰
        for (let i = 0; i < maxDisks; i++) {
            const idx = Math.floor(i * (ordered.length / maxDisks));
            selectedIndexes.push(ordered[idx]);
        }

        // å°ã•ã„é †ã«ä¸¦ã¹æ›¿ãˆï¼ˆã‚µã‚¤ã‚º1ãŒé«˜éŸ³ï¼‰
        selectedIndexes.sort((a, b) => b - a);
    }

    // ã‚µã‚¤ã‚ºã«å¯¾å¿œã™ã‚‹éŸ³ã‚’é¸ã¶ï¼ˆdiskSizeã¯1ãŒæœ€å°ï¼ŒmaxDisksãŒæœ€å¤§ï¼‰
    const soundIndex = selectedIndexes[diskSize - 1];

    const audio = moveSounds[soundIndex]?.cloneNode();
    if (audio) {
        audio.currentTime = 0;
        audio.play();
    }
}


// ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–é–¢æ•°
function initializeGame(numDisks, pattern, mode) {
  const towers = [
    document.getElementById('tower-0'),
    document.getElementById('tower-1'),
    document.getElementById('tower-2')
  ];

  towers.forEach(tower => tower.innerHTML = '');

  // é«˜ã•è¨ˆç®—
    let baseHeight = 250;
    let extraHeightPerDisk = 20;

    let adjustedHeight = baseHeight + (numDisks - 3) * extraHeightPerDisk;
    adjustedHeight = Math.max(adjustedHeight, 300);
    // adjustedHeight = Math.min(adjustedHeight, 1000);

    

    // æœ€å¤§ãƒ‡ã‚£ã‚¹ã‚¯å¹…è¨ˆç®—
    // const maxDiskWidth = numDisks * 20 + 30;
    let maxDiskWidth = window.innerWidth/4;
    if (numDisks < 10) {
        maxDiskWidth = window.innerWidth/5;
    }
    const towerWidth = maxDiskWidth + 40;
    const minDiskWidth = 60;   // æœ€å°ãƒ‡ã‚£ã‚¹ã‚¯ã®å¹…ï¼ˆä¾‹ï¼‰
    const step = (maxDiskWidth - minDiskWidth) / (numDisks - 1);

    towers.forEach(tower => {
        tower.style.height = `${adjustedHeight}px`;
        tower.style.width = `${towerWidth}px`;
    });


  for (let i = numDisks; i >= 1; i--) {
    const disk = document.createElement('div');
    disk.className = 'disk';
    disk.dataset.size = i;
    disk.style.width = `${(i-1) * step + minDiskWidth}px`;
    const accessibleColors = [
      '#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231',
      '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe',
      '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000',
      '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080'
    ];
    disk.style.backgroundColor = accessibleColors[(i - 1) % accessibleColors.length];

    if (pattern === 'on') {
      const angle = (i * 30) % 360; // å††ç›¤ã®ã‚µã‚¤ã‚ºã«åŸºã¥ã„ã¦è§’åº¦ã‚’å¤‰åŒ–
      const gradientStops = [
        `rgba(0,0,0,0.5) ${5 + (i * 2) % 10}px`,
        `transparent ${10 + (i * 3) % 15}px`
      ];
      disk.style.backgroundImage = `repeating-linear-gradient(
        ${angle}deg,
        rgba(0,0,0,0.5),
        ${gradientStops.join(', ')}
      )`;
    } else if (pattern === 'number') {
      disk.textContent = i; // æ•°å­—ã‚’è¡¨ç¤º
      disk.style.color = '#fff';
      disk.style.textAlign = 'center';
      disk.style.fontWeight = 'bold';
    }

    towers[0].appendChild(disk);
  }

    if (mode === 'drag') {
        setupDragAndDrop(towers);
    } else if (mode === 'click') {
        setupClickToMove(towers);
    } else if (mode === 'keyboard') {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸåŒ–
    } else if (mode === 'natural') {
        setupNaturalLanguageMode(towers);
    }
    else if (mode === 'voice') {
        setupVoiceControlMode(towers);
    }
}

// ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
function setupDragAndDrop(towers) {


    towers.forEach(tower => {
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä¸€åº¦ã ã‘å‰Šé™¤ã—ã€å†è¨­å®šã™ã‚‹
        tower.ondragover = null;
        tower.ondrop = null;
        tower.onclick = null; // ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        Array.from(tower.children).forEach(disk => {
            disk.draggable = false;
            disk.ondragstart = null;
            disk.classList.remove('clickable'); // ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        });

        tower.ondragover = e => e.preventDefault(); // ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã«å¿…è¦
        tower.ondrop = e => {
            e.preventDefault();
            const draggedDiskSize = e.dataTransfer.getData('text/plain'); // ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ‡ã‚£ã‚¹ã‚¯ã‚µã‚¤ã‚ºã‚’å–å¾—
            const draggedDisk = document.querySelector(`.disk.dragging[data-size="${draggedDiskSize}"]`); // æ­£ç¢ºãªãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’å–å¾—
            if (!draggedDisk) return; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„

            const topDisk = tower.lastElementChild;

            // ç§»å‹•ãƒ«ãƒ¼ãƒ«ã®ç¢ºèª: ç§»å‹•ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ‡ã‚£ã‚¹ã‚¯ãŒã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å¡”ã®æœ€ä¸Šéƒ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚ˆã‚Šã‚‚å°ã•ã„ã‹
            if (!topDisk || +draggedDisk.dataset.size < +topDisk.dataset.size) {
                const oldSourceTower = draggedDisk.parentElement; // å¤ã„ã‚½ãƒ¼ã‚¹å¡”
                tower.appendChild(draggedDisk); // ãƒ‡ã‚£ã‚¹ã‚¯ã‚’æ–°ã—ã„å¡”ã«ç§»å‹•

                // ç§»å‹•ã‚’è¨˜éŒ²
                recordMove(oldSourceTower.id, tower.id, draggedDisk.dataset.size);
            } else {
                // ç„¡åŠ¹ãªç§»å‹•ã®å ´åˆ
                sounds.invalid.currentTime = 0;
                sounds.invalid.play();
                alert('å°ã•ã„å††ç›¤ã®ä¸Šã«å¤§ãã„å††ç›¤ã‚’ç§»å‹•ã•ã›ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼');
            }
            draggedDisk.classList.remove('dragging'); // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            updateDraggableDisks(); // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªãƒ‡ã‚£ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’æ›´æ–°

            clearTowerHighlights();
        };
    });
    updateDraggableDisks(); // åˆæœŸãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãƒ‡ã‚£ã‚¹ã‚¯ã‚’è¨­å®š
}

// ã‚¯ãƒªãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
function setupClickToMove(towers) {


    towers.forEach(tower => {
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®šã™ã‚‹
        tower.ondragover = null;
        tower.ondrop = null;
        Array.from(tower.children).forEach(disk => {
            disk.draggable = false; // ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯ã«ã™ã‚‹
            disk.ondragstart = null;
        });

        tower.onclick = (event) => { // å¡”å…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
            const clickedElement = event.target;
            // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã®ãŒãƒ‡ã‚£ã‚¹ã‚¯ã®å ´åˆã€ã¾ãŸã¯å¡”è‡ªèº«ã®å ´åˆ
            if (clickedElement.classList.contains('disk') || clickedElement.classList.contains('tower')) {
                const targetTower = clickedElement.classList.contains('tower') ? clickedElement : clickedElement.parentElement;
                const clickedDisk = clickedElement.classList.contains('disk') ? clickedElement : null;

                handleDiskClick(targetTower, clickedDisk);
            }
        };
    });
    updateClickableDisks(); // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒ‡ã‚£ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’åˆæœŸåŒ–
}

function setupNaturalLanguageMode(towers) {

    // å…¥åŠ›æ¬„ã¨é€ä¿¡ãƒœã‚¿ãƒ³ã®è¡¨ç¤º
    const nlpControls = document.getElementById('nlp-controls');
    nlpControls.style.display = 'block';

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è‡ªå‹•ã§å…¥åŠ›æ¬„ã«å½“ã¦ã‚‹
    const input = document.getElementById('nlp-input');
    input.focus();

    // ã¾ã å­˜åœ¨ã—ãªã‘ã‚Œã°èª¬æ˜ã‚¬ã‚¤ãƒ‰ã‚’è¿½åŠ 
    if (!document.getElementById('nlp-guide')) {
        const guide = document.createElement('div');
        guide.id = 'nlp-guide';
        guide.style.marginTop = '10px';
        guide.style.fontSize = '0.9em';
        guide.style.color = '#555';
        guide.style.background = '#eef';
        guide.style.padding = '10px';
        guide.style.borderRadius = '5px';
        guide.innerHTML = `
            <strong>è‡ªç„¶è¨€èªæ“ä½œä¾‹:</strong><br>
            ã€Œå·¦ã‹ã‚‰å³ã«å‹•ã‹ã—ã¦ã€<br>
            ã€Œä¸­å¤®ã®å¡”ã‹ã‚‰å³ã¸ã€<br>
            ã€ŒçœŸã‚“ä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’å·¦ã«æŒã£ã¦ã„ã£ã¦ã€<br>
            ã€Œå³ã‹ã‚‰ä¸­ã«ç§»å‹•ã—ã¦ã€ãªã©
        `;
        document.getElementById('game-screen').insertBefore(guide, document.getElementById('toggle-history-under'));
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ã‚„ã‚¯ãƒªãƒƒã‚¯ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
    towers.forEach(tower => {
        tower.ondrop = null;
        tower.ondragover = null;
        tower.onclick = null;
        Array.from(tower.children).forEach(disk => {
            disk.draggable = false;
            disk.onclick = null;
            disk.classList.remove('clickable', 'dragging');
        });
    });
}


// ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã§ã‚‚å…±é€šä½¿ç”¨)
function handleDiskClick(tower, clickedDisk) {
    const topDisk = tower.lastElementChild;

    if (!selectedDisk) {
        // ã¾ã ãƒ‡ã‚£ã‚¹ã‚¯ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ
        // clickedDisk ãŒå­˜åœ¨ã—ã€ãã‚ŒãŒæœ€ä¸Šéƒ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ã§ã‚ã‚‹ã‹ã‚’ç¢ºèª
        if (topDisk && clickedDisk && clickedDisk === topDisk) {
            selectedDisk = topDisk;
            sourceTower = tower;
            selectedDisk.classList.add('dragging'); // é¸æŠä¸­ã®è¦–è¦šçš„åŠ¹æœ
            selectedDisk.classList.add('clickable'); // ã‚¯ãƒªãƒƒã‚¯é¸æŠçŠ¶æ…‹ã‚’ç¤ºã™
        } else if (clickedDisk && clickedDisk !== topDisk) {
            sounds.invalid.currentTime = 0;
            sounds.invalid.play();
            alert('ä¸€ç•ªä¸Šã«ç½®ã‹ã‚Œã¦ã„ã‚‹å††ç›¤ã—ã‹å‹•ã‹ã›ã¾ã›ã‚“ï¼');
        } else if (!clickedDisk && tower.children.length > 0 && currentMode === 'keyboard') {
            // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã§å¡”ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãŒãƒ‡ã‚£ã‚¹ã‚¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã€æœ€ä¸Šéƒ¨ã‚’é¸æŠ
            // ã“ã‚Œã¯ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã§ã®å¡”é¸æŠã¨ãƒ‡ã‚£ã‚¹ã‚¯é¸æŠã‚’å…¼ã­ã‚‹ãŸã‚ã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ã€‚
            selectedDisk = topDisk;
            sourceTower = tower;
            selectedDisk.classList.add('dragging', 'clickable');
        } else if (clickedDisk === null && tower.children.length === 0) {
            // å¡”ãŒç©ºã§ã€ãƒ‡ã‚£ã‚¹ã‚¯ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆï¼ˆç‰¹ã«ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã§ï¼‰
            // ä½•ã‚‚é¸æŠã•ã‚Œãªã„
        }
        highlightValidTowers(selectedDisk);
    } else {
        // ãƒ‡ã‚£ã‚¹ã‚¯ãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ
        if (tower === sourceTower) {
            // åŒã˜å¡”ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã€é¸æŠã‚’è§£é™¤
            selectedDisk.classList.remove('dragging', 'clickable');
            selectedDisk = null;
            sourceTower = null;
        } else if (!topDisk || +selectedDisk.dataset.size < +topDisk.dataset.size) {
            // æœ‰åŠ¹ãªç§»å‹•ã®å ´åˆ
            tower.appendChild(selectedDisk); // ãƒ‡ã‚£ã‚¹ã‚¯ã‚’æ–°ã—ã„å¡”ã«ç§»å‹•
            recordMove(sourceTower.id, tower.id, selectedDisk.dataset.size); // ç§»å‹•ã‚’è¨˜éŒ²

            selectedDisk.classList.remove('dragging', 'clickable');
            selectedDisk = null;
            sourceTower = null;
        } else {
            // ç„¡åŠ¹ãªç§»å‹•ï¼ˆå°ã•ã„ãƒ‡ã‚£ã‚¹ã‚¯ã®ä¸Šã«å¤§ãã„ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ç½®ã“ã†ã¨ã—ãŸå ´åˆï¼‰
            sounds.invalid.currentTime = 0;
            sounds.invalid.play();
            alert('å°ã•ã„å††ç›¤ã®ä¸Šã«å¤§ãã„å††ç›¤ã‚’ç§»å‹•ã•ã›ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ï¼');
            selectedDisk.classList.remove('dragging', 'clickable'); // é¸æŠè§£é™¤
            selectedDisk = null;
            sourceTower = null;
        }
        clearTowerHighlights();
    }
    if (currentMode === 'click') {
        updateClickableDisks(); // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒ‡ã‚£ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’æ›´æ–°
    }
}

// ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªãƒ‡ã‚£ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateDraggableDisks() {
    const towers = [
        document.getElementById('tower-0'),
        document.getElementById('tower-1'),
        document.getElementById('tower-2')
    ];
    towers.forEach(tower => {
        // ã¾ãšå…¨ã¦ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ä¸å¯ã«è¨­å®š
        Array.from(tower.children).forEach(disk => {
            disk.draggable = false;
            disk.ondragstart = null;
        });

        // æœ€ä¸Šéƒ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ã®ã¿ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«è¨­å®š
        const topDisk = tower.lastElementChild;
        if (topDisk) {
            topDisk.draggable = true;
            topDisk.ondragstart = e => {
                e.dataTransfer.setData('text/plain', topDisk.dataset.size); // ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ãƒ‡ã‚£ã‚¹ã‚¯ã‚µã‚¤ã‚ºã‚’è¨­å®š
                topDisk.classList.add('dragging'); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦–è¦šçš„åŠ¹æœ
                selectedDisk = topDisk;
                highlightValidTowers(selectedDisk);

                topDisk.ondragend = () => {
                    clearTowerHighlights();  // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«å«ã‚€ï¼‰ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆæ¶ˆå»
                    selectedDisk = null; // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«é¸æŠä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’è§£é™¤
                };
            };
        }
    });
}

// ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªãƒ‡ã‚£ã‚¹ã‚¯ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateClickableDisks() {
    const towers = [
        document.getElementById('tower-0'),
        document.getElementById('tower-1'),
        document.getElementById('tower-2')
    ];
    towers.forEach(tower => {
        Array.from(tower.children).forEach(disk => {
            disk.classList.remove('clickable'); // å…¨ã¦ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰clickableã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        });
        const topDisk = tower.lastElementChild;
        if (topDisk && !selectedDisk) { // é¸æŠä¸­ã®ãƒ‡ã‚£ã‚¹ã‚¯ãŒãªã„å ´åˆã®ã¿ã€æœ€ä¸Šéƒ¨ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
            topDisk.classList.add('clickable');
        }
    });
}

function showVictoryMessage() {
    const victoryMessage = document.createElement('div');
    victoryMessage.textContent = 'ğŸ‰ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å…¨ã¦ã®å††ç›¤ã‚’ç§»å‹•ã§ãã¾ã—ãŸï¼ ğŸ‰';
    victoryMessage.style.position = 'fixed';
    victoryMessage.style.top = '50%';
    victoryMessage.style.left = '50%';
    victoryMessage.style.transform = 'translate(-50%, -50%)';
    victoryMessage.style.fontSize = '2em';
    victoryMessage.style.background = 'white';
    victoryMessage.style.padding = '20px';
    victoryMessage.style.border = '2px solid #888';
    victoryMessage.style.borderRadius = '10px';
    victoryMessage.style.zIndex = '9999';
    victoryMessage.style.boxShadow = '0 0 20px rgba(0,0,0,0.3)';
    document.body.appendChild(victoryMessage);
    setTimeout(() => {
        document.body.removeChild(victoryMessage);
    }, 4000);
}


function checkVictory() {
    const rightTower = document.getElementById('tower-2');
    const totalDisks = parseInt(document.getElementById('disk-select').value);
    const disksOnRight = rightTower.querySelectorAll('.disk').length;

    if (disksOnRight === totalDisks) {
        stopTimer();  // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
        const timeStr = getElapsedTimeString();
        setTimeout(() => {
            sounds.victory.currentTime = 0;
            sounds.victory.play();

            const popup = document.getElementById('victory-popup');
            popup.style.display = 'block';
            // æ—¢å­˜ã®æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰çµæœã‚’è¡¨ç¤º
            const oldResult = popup.querySelector('.result-info');
            if (oldResult) oldResult.remove();

            const result = document.createElement('p');
            result.className = 'result-info';
            result.textContent = `çµŒéæ™‚é–“: ${timeStr} ï¼ æ‰‹æ•°: ${moveCount}`;
            popup.insertBefore(result, popup.querySelector('button')); 
        }, 200);
    }
}


// ç§»å‹•ã‚’è¨˜éŒ²ã™ã‚‹å…±é€šé–¢æ•°
function recordMove(fromId, toId, diskSize) {
    // ãƒ‡ã‚£ã‚¹ã‚¯è¦ç´ ã‚’å†åº¦å–å¾—ã™ã‚‹éš›ã€selectedDiskãŒnullã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€
    // å¼•æ•°ã¨ã—ã¦æ¸¡ã•ã‚ŒãŸdiskSizeã¨ã€ãã‚Œã«å¯¾å¿œã™ã‚‹æ—¢å­˜ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’æ¢ã™ã‚ˆã†ã«å¤‰æ›´
    const disk = document.querySelector(`.disk[data-size="${diskSize}"]`);
    if (!disk) return; // ãƒ‡ã‚£ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯è¨˜éŒ²ã—ãªã„

    previousMoves.push([fromId, toId, diskSize]);
    moveCount++;
    document.getElementById('move-count').textContent = moveCount;

    const fromLabel = document.getElementById(fromId).dataset.label;
    const toLabel = document.getElementById(toId).dataset.label;

    const entry = document.createElement('div');
    const diskClone = disk.cloneNode(true); // ãƒ‡ã‚£ã‚¹ã‚¯ã®ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆ
    diskClone.style.margin = '0 5px';
    diskClone.style.height = '15px';
    diskClone.style.pointerEvents = 'none'; // ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã‚ˆã†ã«ã™ã‚‹

    entry.appendChild(diskClone);
    entry.appendChild(document.createTextNode(` ã‚’ ${fromLabel} â†’ ${toLabel}`));
    const historyLog = document.getElementById('history-log');
    historyLog.appendChild(entry);
    historyLog.scrollTop = historyLog.scrollHeight; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’ä¸€ç•ªä¸‹ã¸
    sounds.move.currentTime = 0;
    // sounds.move.play();
    const totalDisks = parseInt(document.getElementById('disk-select').value);
    playMoveSound(parseInt(diskSize), totalDisks);
    checkVictory(); // å‹åˆ©åˆ¤å®š
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
document.addEventListener('keydown', (e) => {
    // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ãŒã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„
    if (currentMode !== 'keyboard') return;

    if (e.key === 'm' || e.key === 'M') {
        // ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
        document.getElementById('back-btn').click(); // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
    } else if (e.key === 'r' || e.key === 'R') {
        // ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('reset-btn').click(); // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
    } else if (e.key === 'z' || e.key === 'Z') {
        // 1æ‰‹æˆ»ã™
        document.getElementById('undo-btn').click(); // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
    } else if (e.key === 'h' || e.key === 'H') {
        // å±¥æ­´è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('toggle-history').click(); // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
    } else if (['1', '2', '3'].includes(e.key)) {
        const towerIndex = parseInt(e.key) - 1;
        const tower = document.getElementById(`tower-${towerIndex}`);
        if (!tower) return; // å¡”ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        handleDiskClick(tower, tower.lastElementChild);
    }
});

const nlpInput = document.getElementById('nlp-input');
const nlpSubmit = document.getElementById('nlp-submit');

nlpInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        nlpSubmit.click();
    }
});


nlpSubmit.addEventListener('click', async () => {
    const command = nlpInput.value.trim();
    if (!command) return;

    try {
        const response = await fetch('/nlp-command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: command })
        });

        const result = await response.json();

        if (!result.success || !result.command || result.command.from == null || result.command.to == null) {
            alert("ãƒ¢ãƒ‡ãƒ«ã®å‡ºåŠ›ãŒä¸æ˜ã§ã™ï¼š" + JSON.stringify(result));
            return;
        }

        const { from, to } = result.command;

        const towers = [
            document.getElementById('tower-0'),
            document.getElementById('tower-1'),
            document.getElementById('tower-2')
        ];

        selectedDisk = null;
        handleDiskClick(towers[from], towers[from].lastElementChild);
        handleDiskClick(towers[to], null);
        nlpInput.value = '';
    } catch (err) {
        console.error(err);
        alert("ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
});

function setupVoiceControlMode(towers) {

    const voiceControls = document.getElementById('voice-controls');
    voiceControls.style.display = 'block';

    // UIæ›´æ–°
    if (!document.getElementById('voice-guide')) {
        const guide = document.createElement('div');
        guide.id = 'voice-guide';
        guide.style.marginTop = '10px';
        guide.style.fontSize = '0.9em';
        guide.style.color = '#555';
        guide.style.background = '#eef';
        guide.style.padding = '10px';
        guide.style.borderRadius = '5px';
        guide.innerHTML = `
            <strong>éŸ³å£°æ“ä½œä¾‹:</strong><br>
            ã€Œå·¦ã‹ã‚‰å³ã¸ç§»å‹•ã—ã¦ã€<br>
            ã€Œä¸­å¤®ã®å¡”ã‹ã‚‰å³ã€<br>
            ã€Œä¸€ç•ªä¸Šã‚’çœŸã‚“ä¸­ã¸ã€ãªã©
        `;
        document.getElementById('game-screen').insertBefore(guide, document.getElementById('toggle-history-under'));
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    document.getElementById('voice-start').addEventListener('click', () => {
        const status = document.getElementById('voice-status');
        status.textContent = 'éŸ³å£°èªè­˜ä¸­...';

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ja-JP';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = async (event) => {
            const transcript = event.results[0][0].transcript;
            status.textContent = `èªè­˜: ã€Œ${transcript}ã€`;

            try {
                const response = await fetch('/nlp-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ input: transcript })
                });
                const result = await response.json();

                if (!result.success || result.command.from == null || result.command.to == null) {
                    alert("ãƒ¢ãƒ‡ãƒ«ã®å‡ºåŠ›ãŒä¸æ˜ã§ã™ï¼š" + JSON.stringify(result));
                    return;
                }

                const { from, to } = result.command;
                selectedDisk = null;
                handleDiskClick(towers[from], towers[from].lastElementChild);
                handleDiskClick(towers[to], null);

            } catch (err) {
                console.error(err);
                alert("éŸ³å£°ã‚³ãƒãƒ³ãƒ‰ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        };

        recognition.onerror = (event) => {
            status.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + event.error;
        };

        recognition.onend = () => {
            status.textContent += 'ï¼ˆçµ‚äº†ï¼‰';
        };

        recognition.start();
    });

    // ä»–ã®æ“ä½œã‚¤ãƒ™ãƒ³ãƒˆç„¡åŠ¹åŒ–
    towers.forEach(tower => {
        tower.ondrop = null;
        tower.ondragover = null;
        tower.onclick = null;
        Array.from(tower.children).forEach(disk => {
            disk.draggable = false;
            disk.onclick = null;
            disk.classList.remove('clickable', 'dragging');
        });
    });
}


function highlightValidTowers(selectedDisk) {
    if (!highlightEnabled) return;

    const towers = [
        document.getElementById('tower-0'),
        document.getElementById('tower-1'),
        document.getElementById('tower-2')
    ];

    towers.forEach(tower => {
        const topDisk = tower.lastElementChild;
        const topSize = topDisk ? parseInt(topDisk.dataset.size) : Infinity;
        const selectedSize = parseInt(selectedDisk.dataset.size);

        if (tower !== selectedDisk.parentElement && selectedSize < topSize) {
            tower.classList.add('highlight'); // åˆæ³•ãªå¡”ã ã‘ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        } else {
            tower.classList.remove('highlight');
        }
    });
}

function clearTowerHighlights() {
    document.querySelectorAll('.tower').forEach(tower => {
        tower.classList.remove('highlight');
    });
}

function startTimer() {
    startTime = Date.now();
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(updateTimerDisplay, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function updateTimerDisplay() {
    if (!startTime) return;
    const elapsedMs = Date.now() - startTime;
    const seconds = Math.floor(elapsedMs / 1000) % 60;
    const minutes = Math.floor(elapsedMs / 60000);
    const timerElem = document.getElementById('timer-display');
    if (timerElem) {
        timerElem.textContent = `çµŒéæ™‚é–“: ${minutes}:${seconds.toString().padStart(2,'0')}`;
    }
}

function getElapsedTimeString() {
    const elapsedMs = Date.now() - startTime;
    const seconds = Math.floor(elapsedMs / 1000) % 60;
    const minutes = Math.floor(elapsedMs / 60000);
    return `${minutes}åˆ†${seconds}ç§’`;
}



</script>
